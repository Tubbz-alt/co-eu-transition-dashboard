{% extends "template.njk" %}
{% from "govuk/components/panel/macro.njk" import govukPanel %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}

{% set fields = getFields() | await %}
{% set fieldGroups = getProjectGroups() | await %}
{% set fieldType = '' %}

{% block pageTitle %}Project Data Input{% endblock %}

{% block content %}

{% if flash %}
{{ govukErrorSummary({
  titleText: "There is a problem",
  errorList: [
    {
      text: flash
    }
  ]
}) }}
{% endif %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">

  <h1 class="govuk-heading-xl" id="project-list-title">Manage project data input fields</h1>

  <p class="govuk-body-l" id="project-list-info">Changes made to the data input fields will
  be reflected in the downloadable template for the MI commision. </p>

  <p class="govuk-body">
    <a href="{{ config.paths.admin.projectField }}" class="govuk-link">Add a new field</a><br>
    <a href="#" id="reorder-fields" class="govuk-link">Re-order fields</a><br>
  </p>
  <hr class="govuk-section-break govuk-section-break--m">

  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

<div class="order-form">
  <form action="{{ url }}/edit" method="post">
</div>
  {% for fieldGroup in fieldGroups %}
  {% set count = 0 %}
  <table class="govuk-table project-fields">
    <caption class="govuk-table__caption">{{ fieldGroup.name }}</caption>
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
      <th scope="col" class="govuk-table__header order-cell"></th>
      <th scope="col" class="govuk-table__header order-cell"></th>
      <th scope="col" class="govuk-table__header">Field Name</th>
      <th scope="col" class="govuk-table__header">Field Type</th>
      <th scope="col" class="govuk-table__header">Status</th>
      <th scope="col" class="govuk-table__header edit-cell"></th>
      </tr>
    </thead>
    <tbody class="govuk-table__body">
    {% for field in fields | sort(attribute='order') %}
      {% if field.group == fieldGroup.name %}
      {% set count = count + 1 %}
      <tr class="govuk-table__row">
          <td class="govuk-table__cell order-cell">
          {# will be hidden fields #}
          <input type="text" name="fields[][0][order]" value="{{ count }}" />
          <input type="text" name="fields[][0][id]" value="{{ field.id }}" />
          {{ field.order }}
          <br>
          {{ field.id }}
          <img class="move-up" src='/assets/images/up.png'/></td>
          <td class="govuk-table__cell order-cell"><img class="move-down" src='/assets/images/down.png'/></td>
        <td class="govuk-table__cell">{{ field.displayName | default('') | string }}</td>
        {% if field.type == 'group' %}
          {% set fieldType = 'Drop down' %}
        {% elif field.type == 'string' %}
          {% set fieldType = 'Free text' %}
        {% elif field.type == 'integer' %}
          {% set fieldType = 'Number' %}
        {% elif field.type == 'date' %}
          {% set fieldType = 'Date input' %}
        {% elif field.type == 'boolean' %}
          {% set fieldType = 'Yes / No' %}
        {% endif %}
        <td class="govuk-table__cell">{{ fieldType }}</td>          
        <td class="govuk-table__cell">{{ "Active" if (field.isActive == true) else "Not active" }}</td>
        <td class="govuk-table__cell edit-cell"><a href="{{ config.paths.admin.projectField + '/' + field.id }}" class="govuk-link">Edit</a></td>
      </tr>
      {% endif %}
    {% endfor %}
    </tbody>
  </table>
  {% endfor %}

<div class="order-form">
  {{ govukButton({
    text: "Apply changes",
    type: "submit",
    name: "submit",
    preventDoubleClick: true
  }) }}
  &nbsp; 
  {{ govukButton({
    text: "Cancel",
    href: config.paths.projectFieldList,
    preventDoubleClick: true,
    classes: "govuk-button--secondary"
  }) }} 

  </form>

</div>

 </div>
</div>

{% endblock %}

{% block afterScript %}
  <script>
    TRANSITIONDELIVERYDASHBOARD.fieldOrder();
  </script>
{% endblock %}