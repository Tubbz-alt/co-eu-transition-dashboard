{% extends "template.njk" %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/accordion/macro.njk" import govukAccordion %}

{% set projectKey = [] %}
{% set projectValue = [] %}
{% set milestoneValue = [] %}
{% set milestoneKey = [] %}
{% set milestoneFields = [] %}
{% set projectName = '' %}
{% set department = '' %}
{% set cellBlock = "cell-color-"  %}
{% set flag = '' %}

  {% for project in project() | await %}
    {% set projectKey = [] %}
    {% for field in project.fields %}

      {% if (field.name == 'Department') %}
        {% set department = field.value  %}
      {% else %}
      {% set projectKey = (projectKey.push({text: field.name }), projectKey) %}
      {% set projectValue = (projectValue.push({html: "<span class=" + cellBlock + field.value + ">" + field.value + "</span>" }), projectValue) %}

        {% if (field.name == 'Project Name') %}
          {% set projectName = field.value  %}
        {% endif %}
      {% endif %}

    {% endfor %}

    {% for milestone in project.milestones %}
    {% set milestoneValue = [] %}
    {% set milestoneKey = [] %}
    {% for field in milestone.fields %}
      {% set milestoneKey = (milestoneKey.push({text: field.name }), milestoneKey) %} 

      {% if (field.name == 'Due Date') and (field.value < currentDate) %}
        {% set flag = 'red-date' %}
      {% endif %}

      {% set milestoneValue = (milestoneValue.push({html: "<span class=" + flag + ">" + field.value | date("D MMM YYYY") + "</span>"  if field.name == 'Due Date' else 
      "<span>" + field.value + "</span>" }), milestoneValue) %} 

    {% endfor %}
    {% set milestoneFields = (milestoneFields.push(milestoneValue), milestoneFields) %} 
  {% endfor %}

{% endfor %}

{% set milestonesHtml %}
  {{ govukTable({
    classes: "milestones-table",
    head: milestoneKey,
    rows: milestoneFields
  }) }}
{% endset %}

{% block beforeContent %}
{{ govukBackLink({
  text: "Back",
  href: "/"
}) }}
{% endblock %}

{% block pageTitle %}Project Details{% endblock %}

{% block content %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

  <h1 class="govuk-heading-xl project-name">{{ projectName }}</h1>
  <span class="govuk-caption-xl dept-name">{{ department }}</span>

{{ govukTabs({
  items: [
    {
      label: "Project description",
      id: "project-description",
      panel: {
        html: ''
      }
    },
    {
      label: "Project solution",
      id: "project-solution",
      panel: {
        html: ''
      }
    },
    {
      label: "Contact details",
      id: "contact-details",
      panel: {
        html: ''
      }
    }
  ]
}) }}

{{ govukTable({
  head: projectKey,
  rows: [
    projectValue
  ]
}) }}

<a class="govuk-link" href="{{ url }}">View impact and confidence definitions</a>

{{ govukAccordion({
  id: "accordion-default",
  items: [
    {
      heading: {
        text: "Missed milestones"
      },
      content: {
        html: milestonesHtml
      }
    },
    {
      heading: {
        text: "Writing well for specialists"
      },
      content: {
        html: "<p class='govuk-body'>This is the content for Writing well for specialists.</p>"
      }
    },
      {
      heading: {
        text: "Know your audience"
      },
      content: {
        html: "<p class='govuk-body'>This is the content for Know your audience.</p>"
      }
    },
      {
      heading: {
        text: "How people read"
      },
      content: {
        html: "<p class='govuk-body'>This is the content for How people read.</p>"
      }
    }
  ]
}) }}

 </div>
</div>

{% endblock %}
